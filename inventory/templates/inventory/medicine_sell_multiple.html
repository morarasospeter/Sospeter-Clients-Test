{% extends "inventory/base.html" %}
{% load static %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #0d1b2a, #1b263b);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #ffffff;
    }

    h2 {
        color: #ffd700;
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background-color: #1b263b;
        color: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    th, td {
        border: 1px solid #415a77;
        padding: 10px;
        font-size: 16px;
        text-align: left;
    }

    th {
        background-color: #415a77;
        color: #ffffff;
    }

    input, select {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #415a77;
        background-color: #0d1b2a;
        color: #ffffff;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
    }

    input:focus, select:focus {
        background-color: #111d2a;
        border-color: #ffd700;
        box-shadow: 0 0 8px #ffd700;
        outline: none;
        color: #ffffff;
    }

    #searchInput {
        margin-bottom: 15px;
        padding: 10px 12px;
        width: 100%;
        max-width: 400px;
        border-radius: 8px;
        border: 1px solid #415a77;
        background-color: #1b263b;
        color: #ffffff;
        font-size: 16px;
    }

    button, .btn {
        padding: 10px 16px;
        margin: 5px 3px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-success, button[type="submit"] {
        background: linear-gradient(90deg, #28a745, #218838);
        color: #ffffff;
    }

    .btn-success:hover, button[type="submit"]:hover {
        background: linear-gradient(90deg, #218838, #28a745);
        transform: scale(1.05);
    }

    .btn-secondary {
        background: linear-gradient(90deg, #415a77, #334766);
        color: #ffffff;
    }

    .btn-secondary:hover {
        background: linear-gradient(90deg, #334766, #415a77);
        transform: scale(1.05);
    }

    .removeRow {
        background: linear-gradient(90deg, #d9534f, #c9302c);
        color: #ffffff;
    }

    .removeRow:hover {
        background: linear-gradient(90deg, #c9302c, #d9534f);
        transform: scale(1.05);
    }

    #addRowBtn {
        background: linear-gradient(90deg, #3a7ca5, #326d91);
        color: #ffffff;
        border: none;
    }

    #addRowBtn:hover {
        background: linear-gradient(90deg, #326d91, #3a7ca5);
        transform: scale(1.05);
    }

    p.error-msg {
        color: #ff4d4d;
        font-weight: bold;
        text-align: center;
        font-size: 16px;
    }

    @media (max-width: 768px) {
        th, td { font-size: 14px; padding: 8px; }
        input, select { font-size: 15px; padding: 8px; }
        button, .btn { font-size: 15px; padding: 8px 12px; }
        h2 { font-size: 22px; }
    }
</style>

<h2>Sell Medicines</h2>

{% if error %}
<p class="error-msg">{{ error }}</p>
{% endif %}

<input type="text" id="searchInput" placeholder="Search medicines..." value="{{ query|default:'' }}">

<form method="POST" id="sellForm">
    {% csrf_token %}

    <table id="medicineTable">
        <thead>
            <tr>
                <th>Medicine</th>
                <th>Quantity</th>
                <th>Price per Unit</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr class="medicineRow">
                <td>
                    <select name="medicine" class="medicineSelect">
                        <option value="">-- Select Medicine --</option>
                        {% for med in medicines %}
                            <option value="{{ med.id }}" data-price="{{ med.selling_price }}" data-stock="{{ med.quantity }}"
                                {% if preselected_medicine and preselected_medicine.id == med.id %} selected {% endif %}>
                                {{ med.name }} (Stock: {{ med.quantity }})
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="number" name="quantity" class="quantityInput" min="1" value="1"></td>
                <td><input type="number" name="price" class="priceInput" step="0.01" readonly
                    value="{% if preselected_medicine %}{{ preselected_medicine.selling_price }}{% endif %}"></td>
                <td><button type="button" class="removeRow">Remove</button></td>
            </tr>
        </tbody>
    </table>

    <button type="button" id="addRowBtn">+ Add Another Medicine</button>
    <br><br>

    <label for="payment_mode">Payment Mode:</label>
    <select name="payment_mode" required>
        <option value="Cash">Cash</option>
        <option value="Card">Card</option>
        <option value="Mobile">Mobile Payment</option>
    </select>
    <br><br>

    <input type="hidden" name="items" id="itemsInput">
    <button type="submit" class="btn btn-success">Complete Sale</button>
    <br><br>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const addRowBtn = document.getElementById("addRowBtn");
    const tableBody = document.querySelector("#medicineTable tbody");
    const sellForm = document.getElementById("sellForm");
    const searchInput = document.getElementById("searchInput");

    function updatePrice(row) {
        const select = row.querySelector(".medicineSelect");
        const priceInput = row.querySelector(".priceInput");
        const qtyInput = row.querySelector(".quantityInput");

        select.addEventListener("change", function() {
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            const stock = selectedOption.dataset.stock || 0;
            priceInput.value = price;
            qtyInput.max = stock;
        });

        select.dispatchEvent(new Event('change'));
    }

    document.querySelectorAll(".medicineRow").forEach(updatePrice);

    addRowBtn.addEventListener("click", function() {
        const newRow = tableBody.querySelector(".medicineRow").cloneNode(true);
        newRow.querySelector(".quantityInput").value = 1;
        newRow.querySelector(".priceInput").value = "";
        newRow.querySelector(".medicineSelect").selectedIndex = 0;
        tableBody.appendChild(newRow);
        updatePrice(newRow);
        addRemoveListener(newRow);
    });

    function addRemoveListener(row) {
        row.querySelector(".removeRow").addEventListener("click", function() {
            if (tableBody.querySelectorAll(".medicineRow").length > 1) {
                row.remove();
            } else {
                alert("At least one medicine is required.");
            }
        });
    }

    document.querySelectorAll(".medicineRow").forEach(addRemoveListener);

    sellForm.addEventListener("submit", function(e) {
        const items = [];
        document.querySelectorAll(".medicineRow").forEach(row => {
            const select = row.querySelector(".medicineSelect");
            const qty = row.querySelector(".quantityInput").value;
            const price = row.querySelector(".priceInput").value;
            if (select.value) {
                items.push({
                    medicine_id: select.value,
                    quantity: qty,
                    price: price
                });
            }
        });
        document.getElementById("itemsInput").value = JSON.stringify(items);
    });

    searchInput.addEventListener("keyup", function() {
        const filter = searchInput.value.toLowerCase();
        document.querySelectorAll(".medicineSelect option").forEach(option => {
            if (option.text.toLowerCase().includes(filter) || option.value === "") {
                option.style.display = "";
            } else {
                option.style.display = "none";
            }
        });
    });
});
</script>

{% endblock %}
